name: Deploy to Hetzner

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Hetzner
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ubuntu
          key: ${{ secrets.HETZNER_SSH_KEY }}
          password: ${{ secrets.HETZNER_PASSWORD }}
          script: |
            mkdir -p ~/repos
            cd ~/repos
            if [ ! -d client-orchestration/.git ]; then
              GIT_SSH_COMMAND="ssh -i ~/.ssh/github_deploy -o IdentitiesOnly=yes" \
                git clone git@github.com:konawige/client-orchestration.git
            fi
            cd client-orchestration
            git config core.sshCommand "ssh -i ~/.ssh/github_deploy -o IdentitiesOnly=yes"
            git pull origin main
            
            # Pull latest images from registry
            docker compose -f docker-compose-prod.yml pull

            # nothing to build, only images
            # docker compose -f docker-compose-prod.yml build

            # Recreate containers with new images
            docker compose -f docker-compose-prod.yml up -d --force-recreate
            
            # Show status
            docker compose -f docker-compose-prod.yml ps
            
            # Cleanup
            docker image prune -af
            
      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ubuntu
          key: ${{ secrets.HETZNER_SSH_KEY }}
          password: ${{ secrets.HETZNER_PASSWORD }}
          script: |
            sleep 10
            echo "Running health checks..."
            
            # Django Connect health check
            if ! curl -f http://localhost:8000/health; then
              echo "❌ ERROR: Django Connect health check failed"
              exit 1
            fi
            echo "✅ Django Connect is healthy"
            
            # FastAPI health check
            if ! curl -f http://localhost:8001/health; then
              echo "❌ ERROR: FastAPI health check failed"
              exit 1
            fi
            echo "✅ FastAPI is healthy"
            
            # Client UI portal health check
            if ! curl -f http://localhost:4200/; then
              echo "❌ ERROR: Client UI portal health check failed"
              exit 1
            fi
            echo "✅ Client UI portal is healthy"
            
            echo "✅ All health checks passed! Deployment complete!"